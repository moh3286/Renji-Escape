<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Escape Coins</title>
<style>
  :root { --bg:#0f1115; --card:#171a21; --muted:#a8b0c0; --accent:#46b3ff; }
  body { margin:0; font-family:Arial, sans-serif; background:var(--bg); color:#fff; }
  .app { max-width:920px; margin:0 auto; padding:16px; }
  .topbar { display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  .pill { background:#0b0d12; border:1px solid #262b36; padding:8px 10px; border-radius:999px; color:var(--muted); }
  .btn { background:var(--card); border:1px solid #2a3140; color:#fff; padding:10px 14px; border-radius:12px; cursor:pointer; }
  .btn:hover { border-color:#3a4560; }
  .btn.primary { background:linear-gradient(180deg,#1e90ff,#1367c7); border-color:#3c7fd1; }
  .btn.danger { background:#2a1212; border-color:#5b2a2a; }
  .grid { display:grid; grid-template-columns: 1fr; gap:14px; }
  @media (min-width: 860px){ .grid { grid-template-columns: 1fr 320px; } }
  .card { background:var(--card); border:1px solid #262b36; border-radius:18px; padding:14px; box-shadow:0 10px 25px rgba(0,0,0,.25); }
  canvas { width:100%; height:auto; background:#111; border-radius:16px; border:1px solid #2a3140; touch-action:none; }
  .muted { color:var(--muted); }
  .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .hr { height:1px; background:#252a35; margin:12px 0; }
  .list { display:flex; flex-direction:column; gap:10px; }
  .item { display:flex; gap:10px; justify-content:space-between; align-items:center; padding:10px; border:1px solid #262b36; border-radius:14px; background:#12151c; }
  .badge { font-size:12px; padding:4px 8px; border-radius:999px; background:#0b0d12; border:1px solid #262b36; color:var(--muted); }
  .hidden { display:none !important; }
  .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background:#0b0d12; border:1px solid #262b36; padding:2px 6px; border-radius:8px; color:#cfd6e6; }
</style>
</head>
<body>
<div class="app">

  <div class="topbar">
    <div class="row">
      <div class="pill">ğŸ® <b>Escape Coins</b></div>
      <div class="pill">ğŸ’° Ø§Ù„Ø¹Ù…Ù„Ø§Øª: <b id="walletCoins">0</b></div>
      <div class="pill">ğŸ¨ Ø§Ù„Ø³ÙƒÙ†: <b id="skinName">Ø§ÙØªØ±Ø§Ø¶ÙŠ</b></div>
      <div class="pill">ğŸ Ø§Ù„Ù…Ø±Ø­Ù„Ø©: <b id="stageName">1</b></div>
    </div>
    <div class="row">
      <button class="btn" id="btnMenu">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
      <button class="btn" id="btnShop">Ø§Ù„Ù…ØªØ¬Ø±</button>
      <button class="btn danger" id="btnReset">ØªØµÙÙŠØ± Ø§Ù„Ø­ÙØ¸</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div id="screenMenu" class="list">
        <h2 style="margin:0">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h2>
        <div class="muted">ØªØ­Ø±Ùƒ Ø¨Ø§Ù„Ø£Ø³Ù‡Ù… <span class="kbd">â† â†‘ â†“ â†’</span> â€” Ø§Ø¬Ù…Ø¹ Ø§Ù„Ø¹Ù…Ù„Ø§Øª ÙˆØ§Ù‡Ø±Ø¨ Ù…Ù† Ø§Ù„Ø¹Ø¯Ùˆ.</div>
        <div class="hr"></div>
        <div class="row">
          <button class="btn primary" id="btnStart">Ø§Ø¨Ø¯Ø£</button>
          <button class="btn" id="btnContinue">ØªØ§Ø¨Ø¹</button>
          <button class="btn" id="btnHow">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù„Ø¹Ø¨</button>
        </div>
        <div id="howBox" class="card hidden" style="background:#12151c;">
          <div class="muted" style="line-height:1.7">
            - Ù‡Ø¯ÙÙƒ ØªØ¬Ù…Ø¹ Ø£ÙƒØ¨Ø± Ø¹Ø¯Ø¯ Ù…Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Øª.<br>
            - ÙƒÙ„ <b>10 Ù†Ù‚Ø§Ø·</b> ØªØ¯Ø®Ù„ Ù…Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¨Ø®Ù„ÙÙŠØ© Ù…Ø®ØªÙ„ÙØ© ÙˆÙŠØ²ÙŠØ¯ Ø§Ù„ØªØ­Ø¯Ù‘ÙŠ.<br>
            - Ø¥Ø°Ø§ Ù„Ù…Ø³ÙÙƒ Ø§Ù„Ø¹Ø¯Ùˆ: ØªØ®Ø³Ø± Ø§Ù„Ø¬ÙˆÙ„Ø©ØŒ Ù„ÙƒÙ† <b>Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ù…Ø­ÙØ¸Ø© ØªØ¨Ù‚Ù‰ Ù…Ø­ÙÙˆØ¸Ø©</b>.<br>
            - ØªÙ‚Ø¯Ø± ØªÙˆÙ‚Ù/ØªÙƒÙ…Ù„ Ù…Ù† Ø²Ø± Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨.
          </div>
        </div>
      </div>

      <div id="screenGame" class="hidden">
        <canvas id="game" width="640" height="440"></canvas>
        <div class="hr"></div>
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <span class="badge">Ø§Ù„Ù†Ù‚Ø§Ø·: <b id="score">0</b></span>
            <span class="badge">Ø§Ù„Ù…Ø±Ø­Ù„Ø©: <b id="stageInGame">1</b></span>
            <span class="badge">Ø§Ù„Ø³Ø±Ø¹Ø©: <b id="diff">1.0x</b></span>
          </div>
          <div class="row">
            <button class="btn primary" id="btnPause">Ø¥ÙŠÙ‚Ø§Ù</button>
            <button class="btn" id="btnQuit">Ø®Ø±ÙˆØ¬</button>
          </div>
        </div>
        <div class="muted" style="margin-top:8px">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ø£Ø³Ù‡Ù… Ù‡Ù†Ø§ Ù„Ø§ ØªØ­Ø±Ùƒ Ø§Ù„ØµÙØ­Ø©.</div>
      </div>

      <div id="screenShop" class="hidden">
        <h2 style="margin:0">ğŸ›’ Ø§Ù„Ù…ØªØ¬Ø±</h2>
        <div class="muted">Ø§Ø´ØªØ±ÙŠ Ø³ÙƒÙ†Ø§Øª Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù…Ø­ÙØ¸ØªÙƒ.</div>
        <div class="hr"></div>
        <div id="shopList" class="list"></div>
        <div class="hr"></div>
        <div class="row">
          <button class="btn" id="btnBackFromShop">Ø±Ø¬ÙˆØ¹</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin-top:0">Ù„ÙˆØ­Ø© Ø§Ù„Ø­Ø§Ù„Ø©</h3>
      <div class="list">
        <div class="item">
          <div>
            <div><b>Ù…Ø­ÙØ¸ØªÙƒ</b></div>
            <div class="muted">Ø§Ù„Ø¹Ù…Ù„Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</div>
          </div>
          <div class="badge">ğŸ’° <b id="walletCoins2">0</b></div>
        </div>

        <div class="item">
          <div>
            <div><b>Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø©</b></div>
            <div class="muted">Ø£Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø· Ø¨Ø¬ÙˆÙ„Ø© ÙˆØ§Ø­Ø¯Ø©</div>
          </div>
          <div class="badge">ğŸ† <b id="bestScore">0</b></div>
        </div>

        <div class="item">
          <div>
            <div><b>Ø¢Ø®Ø± Ù†ØªÙŠØ¬Ø©</b></div>
            <div class="muted">Ø¢Ø®Ø± Ø¬ÙˆÙ„Ø© Ù„Ø¹Ø¨ØªÙ‡Ø§</div>
          </div>
          <div class="badge">ğŸ§¾ <b id="lastScore">0</b></div>
        </div>

        <div class="item">
          <div>
            <div><b>Ù…ÙØªØ§Ø­ Ø³Ø±ÙŠØ¹</b></div>
            <div class="muted">ØªÙˆÙ‚ÙŠÙ / ØªØ´ØºÙŠÙ„</div>
          </div>
          <div class="badge"><span class="kbd">Space</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (LocalStorage)
========================= */
const STORE_KEY = "escape_coins_save_v1";
function loadSave(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if(!raw) return null;
    return JSON.parse(raw);
  }catch{ return null; }
}
function saveNow(){
  localStorage.setItem(STORE_KEY, JSON.stringify(SAVE));
}
function resetSave(){
  localStorage.removeItem(STORE_KEY);
}

let SAVE = loadSave() || {
  walletCoins: 0,
  ownedSkins: { "default": true },
  equippedSkin: "default",
  bestScore: 0,
  lastScore: 0,
  hasContinue: false,
  continueState: null
};

const SKINS = [
  { id:"default", name:"Ø§ÙØªØ±Ø§Ø¶ÙŠ", price:0, shape:"circle", color:"#46b3ff" },
  { id:"emerald", name:"Ø²Ù…Ø±Ø¯", price:40, shape:"circle", color:"#23d18b" },
  { id:"golden",  name:"Ø°Ù‡Ø¨ÙŠ",  price:80, shape:"circle", color:"#ffd166" },
  { id:"shadow",  name:"Ø¸Ù„",    price:140, shape:"circle", color:"#b6b6ff" },
  { id:"pixel",   name:"Ø¨ÙŠÙƒØ³Ù„", price:220, shape:"square", color:"#ff5c8a" },
];

const STAGES = [
  { id:1, name:"1", bgType:"grid" },
  { id:2, name:"2", bgType:"stars" },
  { id:3, name:"3", bgType:"waves" },
  { id:4, name:"4", bgType:"sand" },
  { id:5, name:"5", bgType:"matrix" },
];

/* =========================
   ÙˆØ§Ø¬Ù‡Ø©
========================= */
const el = (id)=>document.getElementById(id);
const screens = {
  menu: el("screenMenu"),
  game: el("screenGame"),
  shop: el("screenShop"),
};
function showScreen(name){
  for(const k of Object.keys(screens)) screens[k].classList.add("hidden");
  screens[name].classList.remove("hidden");
}

function refreshHUD(){
  el("walletCoins").textContent = SAVE.walletCoins;
  el("walletCoins2").textContent = SAVE.walletCoins;
  el("bestScore").textContent = SAVE.bestScore;
  el("lastScore").textContent = SAVE.lastScore;
  const skin = SKINS.find(s=>s.id===SAVE.equippedSkin) || SKINS[0];
  el("skinName").textContent = skin.name;
  el("btnContinue").disabled = !SAVE.hasContinue;
  el("btnContinue").style.opacity = SAVE.hasContinue ? "1" : ".5";
  saveNow();
}

/* =========================
   Ø§Ù„Ù…ØªØ¬Ø±
========================= */
function renderShop(){
  const box = el("shopList");
  box.innerHTML = "";
  SKINS.forEach(s=>{
    const owned = !!SAVE.ownedSkins[s.id];
    const equipped = SAVE.equippedSkin === s.id;

    const row = document.createElement("div");
    row.className = "item";

    const left = document.createElement("div");
    left.innerHTML = `<div><b>${s.name}</b> <span class="badge">${s.shape==="circle"?"Ø¯Ø§Ø¦Ø±Ø©":"Ù…Ø±Ø¨Ø¹"}</span></div>
                      <div class="muted">Ø§Ù„Ø³Ø¹Ø±: ${s.price} ğŸ’°</div>`;

    const right = document.createElement("div");
    const btn = document.createElement("button");
    btn.className = "btn";
    if(equipped){
      btn.textContent = "Ù…ÙØ¬Ù‡Ù‘Ø² âœ…";
      btn.disabled = true;
      btn.style.opacity = ".7";
    }else if(owned){
      btn.textContent = "ØªØ¬Ù‡ÙŠØ²";
      btn.onclick = ()=>{
        SAVE.equippedSkin = s.id;
        refreshHUD();
        renderShop();
      };
    }else{
      btn.textContent = "Ø´Ø±Ø§Ø¡";
      btn.onclick = ()=>{
        if(SAVE.walletCoins < s.price){
          alert("ğŸ’¸ Ù…Ø§ Ø¹Ù†Ø¯Ùƒ Ø¹Ù…Ù„Ø§Øª ÙƒØ§ÙÙŠØ©.");
          return;
        }
        SAVE.walletCoins -= s.price;
        SAVE.ownedSkins[s.id] = true;
        SAVE.equippedSkin = s.id;
        refreshHUD();
        renderShop();
      };
    }

    right.appendChild(btn);
    row.appendChild(left);
    row.appendChild(right);
    box.appendChild(row);
  });
}

/* =========================
   Ø§Ù„Ù„Ø¹Ø¨Ø©
========================= */
const canvas = el("game");
const ctx = canvas.getContext("2d");
const W = canvas.width, H = canvas.height;

let running = false;
let paused = false;
let rafId = null;

let state = null; // current run state

function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function rnd(min,max){ return Math.random()*(max-min)+min; }

const keys = {};
function preventScrollKeys(e){
  if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(e.key)){
    e.preventDefault();
  }
}
document.addEventListener("keydown", (e)=>{
  preventScrollKeys(e);
  keys[e.key] = true;
  if(e.key === " " && screens.game.classList.contains("hidden")===false){
    togglePause();
  }
});
document.addEventListener("keyup", (e)=>{
  preventScrollKeys(e);
  keys[e.key] = false;
});

function stageFromScore(score){
  // ÙƒÙ„ 10 Ù†Ù‚Ø§Ø· Ù…Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
  const idx = Math.min(Math.floor(score / 10), STAGES.length - 1);
  return STAGES[idx];
}
function difficultyMultiplier(score){
  // ØµØ¹ÙˆØ¨Ø© ØªØ²ÙŠØ¯ ØªØ¯Ø±ÙŠØ¬ÙŠÙ‹Ø§: Ù…Ù† 1.0 Ø¥Ù„Ù‰ ~2.3
  return Math.min(1.0 + score * 0.03, 2.3);
}

function newCoin(){
  state.coin.x = rnd(18, W-18);
  state.coin.y = rnd(18, H-18);
}

function resetRun(){
  const skin = SKINS.find(s=>s.id===SAVE.equippedSkin) || SKINS[0];
  state = {
    score: 0,
    stage: STAGES[0],
    skin,
    player: { x: W/2, y: H/2, r: (skin.shape==="circle"?10:10), speed: 3.6 },
    enemy:  { x: 70, y: 70, s: 14, speed: 1.25 },
    coin:   { x: 120, y: 120, r: 7 },
  };
  newCoin();
  updateGameHUD();
}

function updateGameHUD(){
  el("score").textContent = state.score;
  const st = stageFromScore(state.score);
  state.stage = st;
  el("stageInGame").textContent = st.id;
  el("stageName").textContent = st.id;
  const mult = difficultyMultiplier(state.score);
  el("diff").textContent = mult.toFixed(1) + "x";
}

function movePlayer(){
  let dx=0, dy=0;
  if(keys["ArrowUp"]) dy -= 1;
  if(keys["ArrowDown"]) dy += 1;
  if(keys["ArrowLeft"]) dx -= 1;
  if(keys["ArrowRight"]) dx += 1;

  if(dx || dy){
    const len = Math.hypot(dx,dy) || 1;
    dx/=len; dy/=len;
    state.player.x += dx * state.player.speed;
    state.player.y += dy * state.player.speed;
  }

  // Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø´Ø§Ø´Ø©
  if(state.skin.shape==="circle"){
    state.player.x = clamp(state.player.x, state.player.r, W-state.player.r);
    state.player.y = clamp(state.player.y, state.player.r, H-state.player.r);
  }else{
    const half = 10;
    state.player.x = clamp(state.player.x, half, W-half);
    state.player.y = clamp(state.player.y, half, H-half);
  }
}

function moveEnemy(){
  const mult = difficultyMultiplier(state.score);
  const sp = state.enemy.speed * mult;

  // ÙŠØªØ¨Ø¹ Ø§Ù„Ù„Ø§Ø¹Ø¨
  const vx = Math.sign(state.player.x - state.enemy.x);
  const vy = Math.sign(state.player.y - state.enemy.y);
  state.enemy.x += sp * vx;
  state.enemy.y += sp * vy;

  state.enemy.x = clamp(state.enemy.x, 0, W - state.enemy.s);
  state.enemy.y = clamp(state.enemy.y, 0, H - state.enemy.s);
}

function hitCircleCircle(ax, ay, ar, bx, by, br){
  return Math.hypot(ax - bx, ay - by) <= (ar + br);
}
function hitCircleRect(cx, cy, cr, rx, ry, rs){
  const px = clamp(cx, rx, rx + rs);
  const py = clamp(cy, ry, ry + rs);
  return Math.hypot(cx - px, cy - py) <= cr;
}
function hitRectRect(ax,ay,as,bx,by,bs){
  return ax < bx+bs && ax+as > bx && ay < by+bs && ay+as > by;
}

function drawBackground(stage){
  // Ø®Ù„ÙÙŠØ§Øª Ø¨Ø³ÙŠØ·Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø±Ø­Ù„Ø© (Ø®ÙÙŠÙØ© Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø²)
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = "#0e1015";
  ctx.fillRect(0,0,W,H);

  if(stage.bgType==="grid"){
    ctx.strokeStyle = "rgba(255,255,255,0.06)";
    for(let x=0;x<=W;x+=40){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
    for(let y=0;y<=H;y+=40){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }
  }else if(stage.bgType==="stars"){
    ctx.fillStyle = "rgba(255,255,255,0.08)";
    for(let i=0;i<120;i++){
      const x = (i*37)%W, y = (i*91)%H;
      ctx.fillRect(x,y,1,1);
    }
  }else if(stage.bgType==="waves"){
    ctx.strokeStyle = "rgba(70,179,255,0.10)";
    for(let y=20;y<H;y+=26){
      ctx.beginPath();
      for(let x=0;x<=W;x+=16){
        const yy = y + Math.sin((x+y)*0.03)*6;
        if(x===0) ctx.moveTo(x,yy); else ctx.lineTo(x,yy);
      }
      ctx.stroke();
    }
  }else if(stage.bgType==="sand"){
    ctx.fillStyle = "rgba(255,209,102,0.06)";
    for(let i=0;i<220;i++){
      const x=(i*53)%W, y=(i*29)%H;
      ctx.fillRect(x,y,2,1);
    }
  }else if(stage.bgType==="matrix"){
    ctx.fillStyle = "rgba(35,209,139,0.08)";
    for(let x=10;x<W;x+=18){
      const h = ((x*13)%120)+40;
      ctx.fillRect(x, (x*7)%H, 2, h);
    }
  }
}

function draw(){
  drawBackground(state.stage);

  // coin
  ctx.fillStyle = "lime";
  ctx.beginPath();
  ctx.arc(state.coin.x, state.coin.y, state.coin.r, 0, Math.PI*2);
  ctx.fill();

  // enemy
  ctx.fillStyle = "red";
  ctx.fillRect(state.enemy.x, state.enemy.y, state.enemy.s, state.enemy.s);

  // player (skin)
  ctx.fillStyle = state.skin.color;
  if(state.skin.shape==="circle"){
    ctx.beginPath();
    ctx.arc(state.player.x, state.player.y, state.player.r, 0, Math.PI*2);
    ctx.fill();
  }else{
    const s = 20;
    ctx.fillRect(state.player.x - s/2, state.player.y - s/2, s, s);
  }

  if(paused){
    ctx.fillStyle="rgba(0,0,0,0.45)";
    ctx.fillRect(0,0,W,H);
    ctx.fillStyle="#fff";
    ctx.font="24px Arial";
    ctx.textAlign="center";
    ctx.fillText("â¸ Ù…ØªÙˆÙ‚Ù", W/2, H/2);
    ctx.font="14px Arial";
    ctx.fillStyle="rgba(255,255,255,0.85)";
    ctx.fillText("Ø§Ø¶ØºØ· Space Ø£Ùˆ Ø²Ø± (Ø§Ø³ØªØ¦Ù†Ø§Ù)", W/2, H/2 + 28);
    ctx.textAlign="start";
  }
}

function onCollect(){
  state.score += 1;

  // ÙƒÙ„ Ø¹Ù…Ù„Ø© = ØªØ²ÙŠØ¯ Ù…Ø­ÙØ¸ØªÙƒ 1
  SAVE.walletCoins += 1;

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±Ø­Ù„Ø© ÙˆØ§Ù„ØµØ¹ÙˆØ¨Ø©
  updateGameHUD();
  refreshHUD();

  // Ù…ÙƒØ§ÙØ£Ø© ØµØºÙŠØ±Ø© ÙƒÙ„ 10 Ù†Ù‚Ø§Ø· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ): +2 Ø¹Ù…Ù„Ø§Øª
  if(state.score % 10 === 0){
    SAVE.walletCoins += 2;
    refreshHUD();
  }

  newCoin();

  // Ø­ÙØ¸ â€œØªØ§Ø¨Ø¹â€
  SAVE.hasContinue = true;
  SAVE.continueState = packContinue();
  saveNow();
}

function onLose(){
  running = false;
  paused = false;
  if(rafId) cancelAnimationFrame(rafId);
  rafId = null;

  SAVE.lastScore = state.score;
  if(state.score > SAVE.bestScore) SAVE.bestScore = state.score;

  // Ù…Ø§ Ù†Ù…Ø³Ø­ Ø§Ù„Ù…Ø­ÙØ¸Ø©. Ø¨Ø³ Ù†Ù…Ø³Ø­ â€œØªØ§Ø¨Ø¹â€ Ù„Ø£Ù† Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù†ØªÙ‡Øª
  SAVE.hasContinue = false;
  SAVE.continueState = null;
  saveNow();
  refreshHUD();

  alert("ğŸ’€ Ø®Ø³Ø±Øª! Ù†Ù‚Ø§Ø·Ùƒ: " + state.score + "\nğŸ’° Ø¹Ù…Ù„Ø§ØªÙƒ Ø¨Ø§Ù„Ù…Ø­ÙØ¸Ø©: " + SAVE.walletCoins);
  showScreen("menu");
}

function packContinue(){
  // Ø®ÙÙŠÙ: Ù†Ø®Ø²Ù† Ø£Ø´ÙŠØ§Ø¡ Ø£Ø³Ø§Ø³ÙŠØ©
  return {
    score: state.score,
    player: { x: state.player.x, y: state.player.y },
    enemy: { x: state.enemy.x, y: state.enemy.y },
    coin:  { x: state.coin.x,  y: state.coin.y },
    equippedSkin: SAVE.equippedSkin
  };
}
function loadContinue(cont){
  const skin = SKINS.find(s=>s.id===cont.equippedSkin) || SKINS[0];
  state = {
    score: cont.score || 0,
    stage: stageFromScore(cont.score || 0),
    skin,
    player: { x: cont.player.x, y: cont.player.y, r: (skin.shape==="circle"?10:10), speed: 3.6 },
    enemy:  { x: cont.enemy.x,  y: cont.enemy.y,  s: 14, speed: 1.25 },
    coin:   { x: cont.coin.x,   y: cont.coin.y,   r: 7 },
  };
  updateGameHUD();
}

function checkCollisions(){
  // coin collision
  if(state.skin.shape==="circle"){
    if(hitCircleCircle(state.player.x, state.player.y, state.player.r, state.coin.x, state.coin.y, state.coin.r)){
      onCollect();
    }
    // enemy collision
    if(hitCircleRect(state.player.x, state.player.y, state.player.r, state.enemy.x, state.enemy.y, state.enemy.s)){
      onLose();
      return;
    }
  }else{
    // player is square centered
    const ps = 20;
    const px = state.player.x - ps/2, py = state.player.y - ps/2;

    // coin vs square: ØªÙ‚Ø±ÙŠØ¨ Ø¨Ø³ÙŠØ·
    if(hitCircleRect(state.coin.x, state.coin.y, state.coin.r, px, py, ps)){
      onCollect();
    }
    // enemy square vs player square
    if(hitRectRect(px, py, ps, state.enemy.x, state.enemy.y, state.enemy.s)){
      onLose();
      return;
    }
  }
}

function loop(){
  if(!running) return;

  if(!paused){
    movePlayer();
    moveEnemy();
    checkCollisions();
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±Ø­Ù„Ø© ÙƒÙ„ ÙØ±ÙŠÙ… Ø­Ø³Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·
    state.stage = stageFromScore(state.score);
  }

  draw();
  rafId = requestAnimationFrame(loop);
}

function startNewGame(){
  resetRun();
  running = true;
  paused = false;
  SAVE.hasContinue = true;
  SAVE.continueState = packContinue();
  saveNow();
  showScreen("game");
  el("btnPause").textContent = "Ø¥ÙŠÙ‚Ø§Ù";
  loop();
}

function togglePause(){
  if(!running) return;
  paused = !paused;
  el("btnPause").textContent = paused ? "Ø§Ø³ØªØ¦Ù†Ø§Ù" : "Ø¥ÙŠÙ‚Ø§Ù";
}

function continueGame(){
  if(!SAVE.hasContinue || !SAVE.continueState) return;
  // ØªØ£ÙƒØ¯ Ø§Ù„Ø³ÙƒÙ† Ù…ØªÙˆØ§ÙÙ‚
  SAVE.equippedSkin = SAVE.continueState.equippedSkin || SAVE.equippedSkin;
  refreshHUD();
  loadContinue(SAVE.continueState);
  running = true;
  paused = false;
  showScreen("game");
  el("btnPause").textContent = "Ø¥ÙŠÙ‚Ø§Ù";
  loop();
}

/* =========================
   Ø£Ø²Ø±Ø§Ø±
========================= */
el("btnStart").onclick = startNewGame;
el("btnContinue").onclick = continueGame;

el("btnHow").onclick = ()=>{
  el("howBox").classList.toggle("hidden");
};

el("btnPause").onclick = ()=> togglePause();

el("btnQuit").onclick = ()=>{
  // Ø­ÙØ¸ â€œØªØ§Ø¨Ø¹â€ Ù‚Ø¨Ù„ Ø§Ù„Ø®Ø±ÙˆØ¬
  SAVE.hasContinue = true;
  SAVE.continueState = packContinue();
  saveNow();
  refreshHUD();
  running = false;
  paused = false;
  if(rafId) cancelAnimationFrame(rafId);
  rafId = null;
  showScreen("menu");
};

el("btnMenu").onclick = ()=>{
  // Ù„Ùˆ ÙƒÙ†Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø©ØŒ Ù†Ø·Ù„Ø¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆÙ†Ø­ÙØ¸
  if(!screens.game.classList.contains("hidden") && running){
    SAVE.hasContinue = true;
    SAVE.continueState = packContinue();
    saveNow();
  }
  refreshHUD();
  showScreen("menu");
};

el("btnShop").onclick = ()=>{
  renderShop();
  showScreen("shop");
};

el("btnBackFromShop").onclick = ()=>{
  showScreen("menu");
};

el("btnReset").onclick = ()=>{
  if(confirm("Ø£ÙƒÙŠØ¯ ØªØ¨ØºÙ‰ ØªØµÙÙŠØ± ÙƒÙ„ Ø§Ù„Ø­ÙØ¸ØŸ (Ø§Ù„Ø¹Ù…Ù„Ø§Øª + Ø§Ù„Ø³ÙƒÙ†Ø§Øª + Ø§Ù„Ø£Ø±Ù‚Ø§Ù…)")){
    resetSave();
    SAVE = {
      walletCoins: 0,
      ownedSkins: { "default": true },
      equippedSkin: "default",
      bestScore: 0,
      lastScore: 0,
      hasContinue: false,
      continueState: null
    };
    refreshHUD();
    renderShop();
    showScreen("menu");
  }
};

/* =========================
   ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ
========================= */
refreshHUD();
renderShop();
showScreen("menu");
</script>
</body>
</html>
